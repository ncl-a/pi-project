<div class="card" *ngIf="task && loggedUser"
    [ngClass]="{
      'not-assigned-task': !userAssignedToTask(loggedUser.id)
    }"
>
  <div class="card-content">
    <div class="card-body">
      <h4 class="card-title">
        <div class="row justify-content-between">
          <div class="col-md-10">
            <!-- TASK TITLE -->
            <ng-container *ngIf="!inModify; else titleModification">

              {{ task.name }}

              <app-badge [icon]="'bi-bell-fill'" [color]="'#db5c5c'" [text]="'news'" *ngIf="task.updated_at > loggedUser.last_visit_at"></app-badge>
            </ng-container>

            <ng-template #titleModification>


              <div class="form-group">
                <textarea
                        class="form-control"
                        id="task-title"
                        placeholder="Task Title"
                        [value]="blueprintModificateTask?.name"

                        appAutoHeight
                        [base]="0"
                        [offset]="10"

                        #titleTA
                        (input)="blueprintModificateTask!.name = titleTA.value">
                </textarea>
              </div>
            </ng-template>
          </div>

          <div class="col-md-auto">
            <!-- MENU -->
            <div class="btn-group mb-1" *ngIf="!inModify; else confirmModifyBtn">
              <div class="dropdown icon-left">
                <button
                  class="btn icon btn-sm btn-light me-1"
                  type="button"
                  id="dropdownMenuButtonIconRight"
                  data-bs-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <div
                  class="dropdown-menu"
                  aria-labelledby="dropdownMenuButtonIconRight"
                >
                  <!-- Modify -->
                  <button class="dropdown-item"
                          [disabled]="!utilsService.canModify(task.author_id)"
                          (click)="inModify = true; openMoreDetailsBtn.click()">
                    <i class="bi bi-pencil me-50"></i>
                    {{ "modify" | translate }}
                  </button>

                  <!-- Delete -->
                  <button class="dropdown-item"
                          data-bs-toggle="modal"
                          [attr.data-bs-target]="'#delete-request-' + task.id"
                          [disabled]="!utilsService.canDelete(task.author_id)">
                    <i class="bi bi-trash me-50"></i>
                    {{ "delete" | translate }}
                  </button>
                </div>
              </div>
            </div>

            <ng-template #confirmModifyBtn>

              <!-- SUBMIT CHANGES -->
              <button class="btn icon icon-right btn-primary"
                      (click)="modify(blueprintModificateTask!)">
                {{ "submit" | translate }}
                <i class="bi bi-check-lg"></i>
              </button>

            </ng-template>

          </div>
        </div>
      </h4>

      <!-- LABELs -->
      <div class="d-flex justify-content-start">
        <ng-container  *ngFor="let label of task.labels">
          <app-badge  [text]="label.name"
                      [color]="label.hex_color"
                      class="cursor-pointer"
                      data-bs-toggle="modal"
                      [attr.data-bs-target]="'#label-' + label.id + '-task-' + task.id + '-modal'">
          </app-badge>

          <app-manage-task-label-modal [target]="'label-' + label.id + '-task-' + task.id + '-modal'" [label]="label"
                                      (onRemoveFromTask)="removeLabelFromTask(label)">
          </app-manage-task-label-modal>
        </ng-container>

        <!-- Add new label -->
        <app-badge  [text]="'+'" class="cursor-pointer"
                    data-bs-toggle="modal"
                    [attr.data-bs-target]="'#add-label-task-' + task.id + '-modal'">
        </app-badge>

        <app-add-task-label-modal [target]="'add-label-task-' + task.id + '-modal'"
                                  [alreadyAssignedLabels]="task.labels ?? []"
                                  (onAdd)="addLabelToTask($event)"
                                  (onClose)="this.onAddLabel.emit({
                                    target: this.task.id,
                                    new: task
                                  });">
        </app-add-task-label-modal>
      </div>

      <!-- DESCRIPTION -->
      <p class="card-text mt-2" *ngIf="task.description">
        <ng-container *ngIf="!inModify; else descriptionModification">

          {{ task.description }}

        </ng-container>

      </p>

      <ng-template #descriptionModification>
        <div class="form-group">
          <textarea
                  class="form-control"
                  id="task-description"
                  rows="auto"
                  [value]="blueprintModificateTask?.description"

                  appAutoHeight

                  #descriptionTA
                  (input)="blueprintModificateTask!.description = descriptionTA.value">
          </textarea>
        </div>
      </ng-template>

        <!-- DEADLINE BADGE -->
      <app-deadline-badge [deadline]="task.deadline"
                          [done]="!!task.task_status?.final"
                          [editable]="(loggedUser && loggedUser.role && loggedUser.role.permission_edit_task_deadline) ?? false"
                          (onDeadlineModified)="modify({
                            deadline: $event
                          })"
                          [id]="'deadline-tas-' + task.id">
      </app-deadline-badge>

      <ng-container>
        <div style="background-color: aqua;">
          id: {{ task.id }} - priority: {{ task.priority }}
        </div>

      </ng-container>

      <!-- MORE DETAILS -->
      <div
        class="accordion accordion-flush mb-1"
        id="moreDeatilsAccordion"
      >
        <div class="accordion-item rounded">
          <h2 class="accordion-header" id="flush-headingOne">
            <button
              class="accordion-button collapsed rounded"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#flush-collapseDetails"
              aria-expanded="false"
              aria-controls="flush-collapseOne"
              #openMoreDetailsBtn
            >
              {{ "more-details" | translate }}
            </button>
          </h2>
          <div
            id="flush-collapseDetails"
            class="accordion-collapse collapse rounded"
            aria-labelledby="flush-headingOne"
            data-bs-parent="#moreDeatilsAccordion"
          >
            <!-- MORE DETAILS BODY (hidden default) -->
            <div class="accordion-body">



            </div>
          </div>
        </div>
      </div>
      <!-- MORE DETAILS END -->


      <!-- TO-DO LIST -->
      <app-task-todo-list [taskId]="task.id" [todoCollapseStatus]="todoCollapseStatus"></app-task-todo-list>

    </div>
  </div>
  <div class="card-footer d-flex justify-content-between">

    <div class="col-md-auto">
      <button class="btn btn-lg icon icon-left btn-outline-primary"
              *ngIf="task.task_status?.default_prev_task_status_id"
              (click)="modify({
                task_status_id: task.task_status?.default_prev_task_status_id
              })">
        <i class="bi bi-arrow-left"></i>

        {{ (prevStatus | async)?.name  }}
      </button>
    </div>

    <div class="col-md-auto">
      <!-- AVATAR OF ASSIGNED USERS -->
      <ng-container *ngFor="let assignedUser of task.assigned_users">
        <app-text-avatar
                        [color]="assignedUser.user.avatar_hex_color"
                        [text]="utilsService.getAvatarText(assignedUser.user)"
                        [tooltip]="assignedUser.user.username"
                        (click)="null"
                        data-bs-toggle="modal"
                        [attr.data-bs-target]="'#' + assignedUser.user.username + '-modal'"
                        class="cursor-pointer me-3">
        </app-text-avatar>
        <app-manage-assigned-user-modal [user]="assignedUser.user"
                                        [target]="assignedUser.user.username + '-modal'"
                                        [assignmentDate]="assignedUser.assigned_at"
                                        (onRemoveFromTask)="removeUserFromTask(assignedUser.user.id)">
        </app-manage-assigned-user-modal>
      </ng-container>

      <ng-container *ngIf="!!loggedUser?.role?.permission_change_assignment">
        <app-icon-avatar  color="5b6370"
                          iconClass="bi bi-plus"
                          tooltip="add-new-user"
                          (click)="null"
                          data-bs-toggle="modal"
                          [attr.data-bs-target]="'#new-assignment-modal-' + task.id"
                          class="cursor-pointer">
        </app-icon-avatar>

        <app-new-assignment-modal
                                  [target]="'new-assignment-modal-' + task.id"
                                  [alreadyAssignedUsers]="getAssignedUsers()"
                                  (onAddAssignment)="addAssignment($event)"
                                  (onClose)="this.onAddAssignment.emit({
                                    target: task.id,
                                    new: task
                                  });">
        </app-new-assignment-modal>
      </ng-container>

      <!-- AVATAR OF ASSIGNED USERS END -->

    </div>

    <div class="col-md-auto">
      <button class="btn btn-lg icon icon-right btn-outline-primary"
              *ngIf="task.task_status?.default_next_task_status_id"
              (click)="modify({
                task_status_id: task.task_status?.default_next_task_status_id
              })">

        {{ (nextStatus | async)?.name  }}

        <i class="bi bi-arrow-right"></i>
      </button>
    </div>
  </div>



  <!-- MODALs -->
  <app-dialog-modal [target]="'delete-request-' + task.id"
                    title="delete-request"
                    [centered]="true"
                    [confirmBtn]="true"
                    [confirmBtnTxt]="'confirm'"
                    [borderless]="true"
                    (onConfirm)="delete()">
  </app-dialog-modal>

</div>
